<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>STORM DROP â€” Battle Royale</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
body{background:#000;overflow:hidden;font-family:'Rajdhani',sans-serif;color:#fff;}
#gc{display:block;position:fixed;inset:0;width:100%;height:100%;cursor:crosshair;}

/* LOADING */
#LS{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#07091a,#0d1b2a,#07091a);
  display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s;}
#LS.out{opacity:0;pointer-events:none;}
.logo{font-family:'Orbitron',sans-serif;font-size:58px;font-weight:900;
  background:linear-gradient(90deg,#ff6b35,#ffd700,#ff6b35);background-size:200%;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:sh 2s linear infinite;letter-spacing:6px;}
@keyframes sh{to{background-position:200% center}}
.sub{font-size:13px;color:#444;letter-spacing:6px;margin-bottom:34px;}
.bw{width:340px;height:4px;background:#111;border:1px solid #1a1a1a;border-radius:2px;margin-bottom:9px;overflow:hidden;}
.bf{height:100%;width:0;background:linear-gradient(90deg,#ff6b35,#ffd700);transition:width .08s;}
.lt{color:#333;font-size:10px;letter-spacing:3px;margin-bottom:28px;}
.dl{color:#666;font-size:10px;letter-spacing:4px;margin-bottom:11px;}
.dr{display:flex;gap:9px;margin-bottom:28px;}
.db{padding:9px 22px;border:2px solid #1a1a1a;background:transparent;color:#444;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;cursor:pointer;border-radius:4px;transition:all .15s;}
.db:hover{border-color:#ffd700;color:#ffd700;}
.db.E{background:#00ff88;border-color:#00ff88;color:#000;}
.db.M{background:#ffd700;border-color:#ffd700;color:#000;}
.db.H{background:#ff4444;border-color:#ff4444;color:#fff;}
.gb{padding:12px 50px;background:linear-gradient(135deg,#ff6b35,#ffd700);border:none;color:#000;
  font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;
  cursor:pointer;border-radius:4px;display:none;transition:all .15s;}
.gb:hover{transform:scale(1.04);box-shadow:0 0 20px rgba(255,200,0,.4);}

/* AIM HINT */
#AH{position:fixed;bottom:0;left:0;right:0;z-index:500;pointer-events:none;
  background:linear-gradient(transparent,rgba(0,0,0,.9));padding:20px 0 16px;
  text-align:center;font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:3px;
  color:#ffd700;transition:opacity .5s;}
#AH.off{opacity:0;}

/* SCOPE OVERLAY */
#scope{position:fixed;inset:0;z-index:300;pointer-events:none;display:none;}
#scope canvas{position:absolute;inset:0;width:100%;height:100%;}
.scope-vignette{position:absolute;inset:0;
  background:radial-gradient(ellipse 35% 55% at 50% 50%, transparent 88%, rgba(0,0,0,.98) 100%);}
.scope-blur{position:absolute;inset:0;
  background:radial-gradient(ellipse 32% 50% at 50% 50%, transparent 85%, rgba(0,0,0,.6) 100%);}
.scope-lines{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
.scope-lines svg{width:180px;height:180px;opacity:.85;}

/* HUD */
#HUD{position:fixed;inset:0;pointer-events:none;z-index:200;display:none;}
.hhp{position:absolute;bottom:175px;left:22px;background:rgba(0,0,0,.75);
  padding:10px 15px;border-radius:7px;border:1px solid #1e1e1e;}
.hl{font-size:9px;letter-spacing:3px;color:#444;margin-bottom:4px;}
.hb{width:165px;height:5px;background:#0e0e0e;border-radius:3px;overflow:hidden;margin-bottom:3px;}
.hbh{height:100%;background:linear-gradient(90deg,#ff2020,#ff8800);border-radius:3px;transition:width .15s;}
.hbs{height:100%;background:linear-gradient(90deg,#1144ff,#00ccff);border-radius:3px;transition:width .15s;}

/* INVENTORY */
#INV{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:5px;}
.sl{width:66px;height:74px;border:2px solid #222;border-radius:5px;
  background:rgba(0,0,0,.8);display:flex;flex-direction:column;align-items:center;
  justify-content:center;position:relative;padding:3px;transition:border-color .1s,background .1s;}
.sl.act{border-color:#ffd700;background:rgba(255,200,0,.1);}
.sl.has{border-color:#333;}
.sl.act.has{border-color:#ffd700;}
.sln{position:absolute;top:2px;left:5px;font-size:8px;color:#333;font-family:'Orbitron',sans-serif;}
.sli{font-size:20px;line-height:1;}
.sll{font-size:6.5px;letter-spacing:.5px;color:#888;margin-top:1px;text-align:center;line-height:1.3;max-width:58px;}
.sla{font-size:8px;font-family:'Orbitron',sans-serif;color:#ffd700;margin-top:1px;}
.slr{width:100%;height:2px;border-radius:1px;margin-top:2px;}
.rc{color:#bbb;}.ru{color:#00ff88;}.rr{color:#4488ff;}.re{color:#cc44ff;}.rl{color:#ffd700;}
.bc{background:#999;}.bu{background:#00ff88;}.br{background:#4488ff;}.be{background:#cc44ff;}.bl{background:#ffd700;}

/* WEAPON INFO */
#WI{position:absolute;bottom:100px;right:22px;background:rgba(0,0,0,.75);
  padding:8px 14px;border-radius:6px;border:1px solid #1e1e1e;text-align:right;}
#WN{font-size:14px;font-weight:700;}
#WR{font-size:9px;letter-spacing:2px;color:#666;margin-top:1px;}
#WA{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#ffd700;line-height:1;}
#WAL{font-size:9px;letter-spacing:2px;color:#555;}

/* MISC HUD */
.hkill{position:absolute;top:16px;right:22px;background:rgba(0,0,0,.75);
  padding:7px 14px;border-radius:5px;border:1px solid #1e1e1e;text-align:center;font-family:'Orbitron',sans-serif;}
.hkn{font-size:22px;font-weight:700;color:#ff6b35;}
.hkl{font-size:7px;letter-spacing:3px;color:#444;}
.halv{position:absolute;top:16px;left:22px;background:rgba(0,0,0,.75);
  padding:7px 14px;border-radius:5px;border:1px solid #1e1e1e;text-align:center;font-family:'Orbitron',sans-serif;}
.han{font-size:22px;font-weight:700;color:#00ff88;}
.hal{font-size:7px;letter-spacing:3px;color:#444;}

/* crosshair */
#XH{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:0;height:0;}
#XH::before,#XH::after{content:'';position:absolute;background:rgba(255,255,255,.9);}
#XH::before{width:2px;height:14px;left:-1px;top:-7px;}
#XH::after{width:14px;height:2px;top:-1px;left:-7px;}
#XH .dot{position:absolute;width:3px;height:3px;background:rgba(255,80,80,.9);border-radius:50%;top:-1.5px;left:-1.5px;}

.hstorm{position:absolute;top:58px;left:50%;transform:translateX(-50%);
  background:rgba(100,0,160,.35);padding:5px 14px;border-radius:4px;
  border:1px solid #6600aa;font-size:10px;letter-spacing:2px;color:#aa44ff;display:none;}
.hmap{position:absolute;bottom:175px;right:22px;width:145px;height:145px;
  border-radius:50%;border:2px solid #ffd700;overflow:hidden;background:#000;}
.kf{position:absolute;top:14px;left:50%;transform:translateX(-50%);
  display:flex;flex-direction:column;gap:3px;align-items:center;min-width:280px;}
.km{background:rgba(0,0,0,.82);padding:4px 11px;border-radius:4px;font-size:10px;
  border-left:3px solid #ff6b35;letter-spacing:1px;animation:kfa 3s forwards;white-space:nowrap;}
@keyframes kfa{0%{opacity:1}80%{opacity:1}100%{opacity:0}}
.ph{position:absolute;bottom:255px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.82);padding:7px 18px;border-radius:5px;font-size:12px;
  letter-spacing:3px;color:#ffd700;border:1px solid #ffd700;display:none;text-align:center;line-height:1.7;}
.pck{position:absolute;bottom:155px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.84);padding:6px 16px;border-radius:4px;font-size:11px;
  letter-spacing:2px;border:1px solid #333;display:none;}
.ch{position:absolute;bottom:98px;right:16px;font-size:8px;letter-spacing:.8px;
  color:#2a2a2a;line-height:1.9;text-align:right;}

/* jump indicator */
#JI{position:absolute;bottom:240px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.7);padding:5px 12px;border-radius:4px;font-size:10px;
  letter-spacing:2px;color:#aaa;display:none;}

/* damage */
#DF{position:fixed;inset:0;background:rgba(255,0,0,.2);pointer-events:none;
  z-index:250;opacity:0;transition:opacity .06s;}
#DF.on{opacity:1;}

/* win/lose */
.OV{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;
  flex-direction:column;align-items:center;justify-content:center;z-index:1000;}
.OV.show{display:flex;}
.OT{font-family:'Orbitron',sans-serif;font-size:50px;font-weight:900;margin-bottom:12px;}
.OS{font-size:14px;color:#555;letter-spacing:4px;margin-bottom:28px;}
.OST{display:flex;gap:32px;margin-bottom:28px;}
.SB{text-align:center;}
.SN{font-family:'Orbitron',sans-serif;font-size:34px;font-weight:700;color:#ffd700;}
.SL{font-size:9px;letter-spacing:3px;color:#444;}
.RB{padding:11px 40px;background:linear-gradient(135deg,#ff6b35,#ffd700);border:none;color:#000;
  font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;
  cursor:pointer;border-radius:4px;pointer-events:all;}
.RB:hover{transform:scale(1.04);}
</style>
</head>
<body>

<div id="LS">
  <div class="logo">STORM DROP</div>
  <div class="sub">BATTLE ROYALE Â· 20 PLAYERS</div>
  <div class="bw"><div class="bf" id="LB"></div></div>
  <div class="lt" id="LT">INITIALIZING...</div>
  <div class="dl">CHOOSE DIFFICULTY</div>
  <div class="dr">
    <button class="db" onclick="setDiff('easy',this)">EASY</button>
    <button class="db" onclick="setDiff('med',this)">MEDIUM</button>
    <button class="db" onclick="setDiff('hard',this)">HARD</button>
  </div>
  <button class="gb" id="GB" onclick="startLoad()">â–¶ DROP IN</button>
  <div style="margin-top:14px;color:#222;font-size:10px;letter-spacing:3px;">20 PLAYERS Â· 1 VICTOR</div>
</div>

<canvas id="gc"></canvas>

<div id="AH">CLICK GAME TO LOCK AIM Â· WASD MOVE Â· SPACE JUMP Â· ESC TO PAUSE</div>

<!-- SCOPE OVERLAY -->
<div id="scope">
  <div class="scope-vignette"></div>
  <div class="scope-blur"></div>
  <div class="scope-lines">
    <svg id="scopeSVG" viewBox="0 0 180 180" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- default sniper reticle, swapped per weapon -->
    </svg>
  </div>
</div>

<div id="HUD">
  <div class="hhp">
    <div class="hl">HEALTH / SHIELD</div>
    <div class="hb"><div class="hbh" id="HPF" style="width:100%"></div></div>
    <div class="hb"><div class="hbs" id="SHF" style="width:0%"></div></div>
  </div>

  <div id="INV">
    <div class="sl act" id="S0"><span class="sln">1</span><span class="sli" style="color:#222">â€”</span></div>
    <div class="sl" id="S1"><span class="sln">2</span><span class="sli" style="color:#222">â€”</span></div>
    <div class="sl" id="S2"><span class="sln">3</span><span class="sli" style="color:#222">â€”</span></div>
    <div class="sl" id="S3"><span class="sln">4</span><span class="sli" style="color:#222">â€”</span></div>
    <div class="sl" id="S4"><span class="sln">5</span><span class="sli" style="color:#222">â€”</span></div>
  </div>

  <div id="WI">
    <div id="WN" class="ru">ASSAULT RIFLE</div>
    <div id="WR">UNCOMMON</div>
    <div id="WA">30</div>
    <div id="WAL">AMMO</div>
  </div>

  <div class="hkill"><div class="hkn" id="KN">0</div><div class="hkl">KILLS</div></div>
  <div class="halv"><div class="han" id="AN">20</div><div class="hal">ALIVE</div></div>
  <div id="XH"><div class="dot"></div></div>
  <div class="hstorm" id="SW">âš  STORM CLOSING</div>
  <div class="hmap"><canvas id="MC" width="145" height="145"></canvas></div>
  <div class="kf" id="KF"></div>
  <div class="ph" id="PH">RIDING BATTLE BUS<br><span style="font-size:10px">CLICK or SPACE to jump</span></div>
  <div class="pck" id="PCK"></div>
  <div id="JI">SPACE = JUMP</div>
  <div class="ch">CLICK TO LOCK AIM Â· WASD MOVE<br>SPACE JUMP Â· 1-5 SLOTS Â· E PICKUP<br>R RELOAD Â· G DROP Â· F USE Â· RMB SCOPE</div>
</div>

<div id="DF"></div>

<div class="OV" id="WIN">
  <div class="OT" style="color:#ffd700">VICTORY!</div>
  <div class="OS">LAST STANDING</div>
  <div class="OST">
    <div class="SB"><div class="SN" id="WK">0</div><div class="SL">KILLS</div></div>
    <div class="SB"><div class="SN" id="WT">0:00</div><div class="SL">TIME</div></div>
  </div>
  <button class="RB" onclick="location.reload()">PLAY AGAIN</button>
</div>
<div class="OV" id="LOSE">
  <div class="OT" style="color:#ff3333">ELIMINATED</div>
  <div class="OS" id="LB2">TAKEN DOWN</div>
  <div class="OST">
    <div class="SB"><div class="SN" id="LK">0</div><div class="SL">KILLS</div></div>
    <div class="SB"><div class="SN" id="LP">â€”</div><div class="SL">PLACE</div></div>
  </div>
  <button class="RB" onclick="location.reload()">TRY AGAIN</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAP=600, HALF=MAP/2, TOTAL=20, GY=0;
const EYE_H=1.8;        // camera eye height
const JUMP_VEL=8;       // jump initial velocity
const GRAVITY=22;       // world gravity
const BUS_Y=165;
const BP={x0:-HALF*.9,z0:-HALF*.65,x1:HALF*.9,z1:HALF*.65};
const BUS_SPD=0.00020;

let diff=null;
const DCFG={
  easy:{react:1400,acc:.10,hp:55, spd:3.2, aimErr:.18},
  med: {react:750, acc:.30,hp:90, spd:4.6, aimErr:.08},
  hard:{react:320, acc:.55,hp:130,spd:6.2, aimErr:.03},
};

// Scope reticles per weapon (SVG paths drawn on scope overlay)
const SCOPES={
  none:   {fov:72, zoom:1,   svg:`<line x1="90" y1="60" x2="90" y2="120" stroke="rgba(255,255,255,.7)" stroke-width="1.5"/><line x1="60" y1="90" x2="120" y2="90" stroke="rgba(255,255,255,.7)" stroke-width="1.5"/><circle cx="90" cy="90" r="3" fill="rgba(255,80,80,.9)"/>`},
  pistol: {fov:65, zoom:1.1, svg:`<circle cx="90" cy="90" r="30" stroke="rgba(255,255,255,.6)" stroke-width="1.2" fill="none"/><line x1="90" y1="55" x2="90" y2="125" stroke="rgba(255,255,255,.6)" stroke-width="1"/><line x1="55" y1="90" x2="125" y2="90" stroke="rgba(255,255,255,.6)" stroke-width="1"/><circle cx="90" cy="90" r="2.5" fill="rgba(255,100,100,.9)"/>`},
  ar:     {fov:60, zoom:1.3, svg:`<circle cx="90" cy="90" r="25" stroke="#00ff88" stroke-width="1.2" fill="none" opacity=".7"/><line x1="90" y1="50" x2="90" y2="75" stroke="#00ff88" stroke-width="1.5" opacity=".8"/><line x1="90" y1="105" x2="90" y2="130" stroke="#00ff88" stroke-width="1.5" opacity=".8"/><line x1="50" y1="90" x2="75" y2="90" stroke="#00ff88" stroke-width="1.5" opacity=".8"/><line x1="105" y1="90" x2="130" y2="90" stroke="#00ff88" stroke-width="1.5" opacity=".8"/><circle cx="90" cy="90" r="2" fill="#00ff88" opacity=".9"/>`},
  smg:    {fov:68, zoom:1.1, svg:`<rect x="75" y="75" width="30" height="30" stroke="rgba(255,200,50,.7)" stroke-width="1" fill="none"/><line x1="90" y1="50" x2="90" y2="130" stroke="rgba(255,200,50,.6)" stroke-width="1"/><line x1="50" y1="90" x2="130" y2="90" stroke="rgba(255,200,50,.6)" stroke-width="1"/><circle cx="90" cy="90" r="2" fill="rgba(255,200,50,.9)"/>`},
  shotgun:{fov:75, zoom:.9,  svg:`<line x1="90" y1="45" x2="90" y2="135" stroke="rgba(255,120,50,.8)" stroke-width="2"/><line x1="45" y1="90" x2="135" y2="90" stroke="rgba(255,120,50,.8)" stroke-width="2"/><circle cx="90" cy="90" r="14" stroke="rgba(255,120,50,.5)" stroke-width="1" fill="none"/><circle cx="90" cy="90" r="3" fill="rgba(255,120,50,.9)"/>`},
  sniper: {fov:15, zoom:6,   svg:`<circle cx="90" cy="90" r="45" stroke="rgba(100,200,255,.8)" stroke-width="1.5" fill="none"/><circle cx="90" cy="90" r="20" stroke="rgba(100,200,255,.6)" stroke-width="1" fill="none"/><line x1="90" y1="44" x2="90" y2="136" stroke="rgba(100,200,255,.9)" stroke-width="1"/><line x1="44" y1="90" x2="136" y2="90" stroke="rgba(100,200,255,.9)" stroke-width="1"/><line x1="55" y1="70" x2="125" y2="70" stroke="rgba(100,200,255,.4)" stroke-width=".8"/><line x1="55" y1="110" x2="125" y2="110" stroke="rgba(100,200,255,.4)" stroke-width=".8"/><circle cx="90" cy="90" r="1.5" fill="rgba(100,200,255,1)"/>`},
  rocket: {fov:55, zoom:1.4, svg:`<circle cx="90" cy="90" r="35" stroke="rgba(255,80,80,.7)" stroke-width="1.5" fill="none"/><circle cx="90" cy="90" r="12" stroke="rgba(255,80,80,.5)" stroke-width="1" fill="none"/><line x1="90" y1="44" x2="90" y2="136" stroke="rgba(255,80,80,.8)" stroke-width="1.5"/><line x1="44" y1="90" x2="136" y2="90" stroke="rgba(255,80,80,.8)" stroke-width="1.5"/><circle cx="90" cy="90" r="3" fill="rgba(255,80,80,1)"/>`},
  golden: {fov:50, zoom:1.6, svg:`<circle cx="90" cy="90" r="30" stroke="#ffd700" stroke-width="1.5" fill="none" opacity=".8"/><circle cx="90" cy="90" r="10" stroke="#ffd700" stroke-width="1" fill="none" opacity=".6"/><line x1="90" y1="44" x2="90" y2="78" stroke="#ffd700" stroke-width="1.5"/><line x1="90" y1="102" x2="90" y2="136" stroke="#ffd700" stroke-width="1.5"/><line x1="44" y1="90" x2="78" y2="90" stroke="#ffd700" stroke-width="1.5"/><line x1="102" y1="90" x2="136" y2="90" stroke="#ffd700" stroke-width="1.5"/><circle cx="90" cy="90" r="2" fill="#ffd700"/>`},
};

const WEAPONS=[
  {name:'Pistol',         rar:'common',    dmg:25,  rate:480,  ammo:12,maxAmmo:12, spread:.06, range:220, bspd:4.5, scope:'pistol', col3:0xaaaaaa},
  {name:'Assault Rifle',  rar:'uncommon',  dmg:30,  rate:125,  ammo:30,maxAmmo:30, spread:.03, range:360, bspd:5.5, scope:'ar',     col3:0x00ff88},
  {name:'SMG',            rar:'common',    dmg:18,  rate:80,   ammo:25,maxAmmo:25, spread:.08, range:180, bspd:5.0, scope:'smg',    col3:0xaaaaaa},
  {name:'Shotgun',        rar:'rare',      dmg:80,  rate:750,  ammo:6, maxAmmo:6,  spread:.15, range:65,  bspd:4.0, scope:'shotgun',col3:0x4488ff},
  {name:'Sniper',         rar:'rare',      dmg:110, rate:1500, ammo:5, maxAmmo:5,  spread:.005,range:700, bspd:8.0, scope:'sniper', col3:0x4488ff},
  {name:'Rocket',         rar:'epic',      dmg:160, rate:2000, ammo:3, maxAmmo:3,  spread:.02, range:450, bspd:3.5, scope:'rocket', col3:0xcc44ff},
  {name:'Gold AR',        rar:'legendary', dmg:48,  rate:105,  ammo:35,maxAmmo:35, spread:.016,range:420, bspd:5.5, scope:'golden', col3:0xffd700},
];
const WI=[
  {icon:'ğŸ”«',color:'#bbb'},
  {icon:'âš¡',color:'#00ff88'},
  {icon:'ğŸ”«',color:'#bbb'},
  {icon:'ğŸ’¥',color:'#4488ff'},
  {icon:'ğŸ¯',color:'#4488ff'},
  {icon:'ğŸš€',color:'#cc44ff'},
  {icon:'â­',color:'#ffd700'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene,cam,renderer,clock;
let player=null, ais=[], bullets=[], loots=[], bldgs=[];
let kills=0, startTime=0, gameRunning=false, gTime=0;
let yaw=0, pitch=0, lastShot=0;
const keys={};
let phase='bus', busT=0, paraVY=0;
let stormR=HALF*.97, stormCX=0, stormCZ=0, stormDmgAcc=0;

// Mouse drag aim
let mDown=false, lmx=0, lmy=0, aimHintShown=true;
// Scoping
let scoping=false, baseFov=72;
// Jumping
let velY=0, onGround=false;
// Inventory
let inv=Array(5).fill(null), aSlot=0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDiff(d,btn){
  diff=d;
  document.querySelectorAll('.db').forEach(b=>b.className='db');
  btn.classList.add(d==='easy'?'E':d==='med'?'M':'H');
  document.getElementById('GB').style.display='block';
}
(function(){
  let p=0;
  const msgs=['BUILDING TERRAIN...','PLACING STRUCTURES...','SPAWNING LOOT...','LOADING AI...','READY!'];
  const iv=setInterval(()=>{
    p+=Math.random()*10+2; if(p>100)p=100;
    document.getElementById('LB').style.width=p+'%';
    document.getElementById('LT').textContent=msgs[Math.min(4,Math.floor(p/25))];
    if(p>=100) clearInterval(iv);
  },100);
})();

function startLoad(){
  if(!diff){alert('Pick a difficulty!');return;}
  const ls=document.getElementById('LS');
  ls.classList.add('out');
  setTimeout(()=>{ls.style.display='none'; document.getElementById('HUD').style.display='block'; initGame();},850);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame(){
  const cvs=document.getElementById('gc');
  cvs.width=window.innerWidth; cvs.height=window.innerHeight;

  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x78c8e8);
  scene.fog=new THREE.FogExp2(0x88d0f0,.0015);

  cam=new THREE.PerspectiveCamera(baseFov,cvs.width/cvs.height,.05,1400);
  cam.rotation.order='YXZ';

  renderer=new THREE.WebGLRenderer({canvas:cvs,antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(cvs.width,cvs.height);
  renderer.shadowMap.enabled=true;
  clock=new THREE.Clock();

  scene.add(new THREE.AmbientLight(0xffffff,.55));
  const sun=new THREE.DirectionalLight(0xfff5cc,1.1);
  sun.position.set(200,350,150); sun.castShadow=true;
  sun.shadow.mapSize.set(2048,2048);
  const sc=sun.shadow.camera;
  sc.left=sc.bottom=-500; sc.right=sc.top=500; sc.far=900;
  scene.add(sun);
  scene.add(new THREE.HemisphereLight(0x87ceeb,0x4a7a2c,.38));

  buildWorld(); spawnLoot(); makeBus(); initPlayer(); initAI(); setupInput(cvs);
  startTime=Date.now(); gameRunning=true;
  document.getElementById('PH').style.display='block';
  loop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Pointer lock state
let pLocked=false;

function setupInput(cvs){
  document.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(e.code==='Space'){
      if(phase==='bus') jumpFromBus();
      else if(phase==='freefall') deployChute();
      else if(phase==='ground'&&onGround){velY=JUMP_VEL;onGround=false;}
    }
    if(e.code==='KeyE') doPickup();
    if(e.code==='KeyR') doReload();
    if(e.code==='KeyG') dropSlot(aSlot);
    if(e.code==='KeyF') useConsumable();
    for(let i=0;i<5;i++) if(e.code==='Digit'+(i+1)) selectSlot(i);
    if(e.code==='KeyQ') selectSlot((aSlot+4)%5);
    if(e.code==='Tab'){e.preventDefault();selectSlot((aSlot+1)%5);}
    if(['Space','Tab'].includes(e.code)) e.preventDefault();
    // ESC releases lock â€” browser handles it, we just update state
  });
  document.addEventListener('keyup',e=>{keys[e.code]=false;});

  // â”€â”€ POINTER LOCK â”€â”€
  document.addEventListener('pointerlockchange',()=>{
    pLocked=(document.pointerLockElement===cvs);
    document.getElementById('AH').style.display=pLocked?'none':'block';
  });
  document.addEventListener('pointerlockerror',()=>{
    document.getElementById('AH').textContent='DRAG TO AIM Â· WASD MOVE Â· SPACE JUMP';
  });

  // mousemove: pointer lock gives clean movementX/Y; fallback = drag delta
  document.addEventListener('mousemove',e=>{
    const sens=scoping?0.0008:0.003;
    if(pLocked){
      yaw  -=e.movementX*sens;
      pitch-=e.movementY*sens;
      pitch=Math.max(-1.3,Math.min(.8,pitch));
    } else if(mDown){
      const dx=e.clientX-lmx, dy=e.clientY-lmy;
      lmx=e.clientX; lmy=e.clientY;
      yaw  -=dx*sens;
      pitch-=dy*sens;
      pitch=Math.max(-1.3,Math.min(.8,pitch));
    }
  });

  // mousedown: ALWAYS handle game actions first, then request lock if needed.
  // Never early-return â€” shooting must work whether or not pointer is locked.
  cvs.addEventListener('mousedown',e=>{
    e.preventDefault();
    mDown=true; lmx=e.clientX; lmy=e.clientY;

    // Request pointer lock on every click (browser ignores if already locked)
    if(!pLocked) cvs.requestPointerLock();

    // Game actions â€” run regardless of lock state
    if(e.button===0){
      if(phase==='bus') jumpFromBus();
      else if(phase==='freefall') deployChute();
      else if(phase==='ground') doShoot();
    }
    if(e.button===2) toggleScope(true);
  });
  document.addEventListener('mouseup',e=>{
    mDown=false;
    if(e.button===2) toggleScope(false);
  });
  document.addEventListener('contextmenu',e=>e.preventDefault());

  cvs.addEventListener('wheel',e=>{
    e.preventDefault();
    selectSlot((aSlot+(e.deltaY>0?1:4))%5);
  },{passive:false});

  window.addEventListener('resize',()=>{
    cam.aspect=window.innerWidth/window.innerHeight;
    cam.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

function hideAimHint(){
  if(!aimHintShown) return;
  aimHintShown=false;
  document.getElementById('AH').classList.add('off');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCOPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleScope(on){
  const item=inv[aSlot];
  if(!item||item.type!=='weapon') return;
  scoping=on;
  const scopeKey=item.w.scope||'none';
  const scopeDef=SCOPES[scopeKey]||SCOPES['none'];
  const targetFov=on?scopeDef.fov:baseFov;
  cam.fov=targetFov;
  cam.updateProjectionMatrix();
  document.getElementById('scope').style.display=on?'block':'none';
  if(on){
    document.getElementById('scopeSVG').innerHTML=scopeDef.svg;
    document.getElementById('XH').style.display='none';
  } else {
    document.getElementById('XH').style.display='block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function darken(h,f){return((Math.floor(((h>>16)&255)*f))<<16)|((Math.floor(((h>>8)&255)*f))<<8)|(Math.floor((h&255)*f));}

function buildWorld(){
  // Ground
  const gg=new THREE.PlaneGeometry(MAP*2.5,MAP*2.5); gg.rotateX(-Math.PI/2);
  const ground=new THREE.Mesh(gg,new THREE.MeshLambertMaterial({color:0x5a9a38}));
  ground.position.y=GY; ground.receiveShadow=true; scene.add(ground);

  // Grid
  const lm=new THREE.MeshBasicMaterial({color:0x4a8a28,transparent:true,opacity:.25});
  for(let i=-6;i<=6;i++){
    const h=new THREE.Mesh(new THREE.PlaneGeometry(MAP*2,.1).rotateX(-Math.PI/2),lm);
    h.position.set(0,GY+.01,i*(MAP/12)); scene.add(h);
    const v=new THREE.Mesh(new THREE.PlaneGeometry(.1,MAP*2).rotateX(-Math.PI/2),lm);
    v.position.set(i*(MAP/12),GY+.01,0); scene.add(v);
  }

  // Ocean
  const oc=new THREE.Mesh(new THREE.PlaneGeometry(MAP*4,MAP*4).rotateX(-Math.PI/2),
    new THREE.MeshLambertMaterial({color:0x1a6090,transparent:true,opacity:.88}));
  oc.position.y=GY-.4; scene.add(oc);

  // Hills
  const hc=[0x6aaa44,0x5a9a34,0x7aba54,0x4a8a24,0x3a7a18];
  for(let i=0;i<20;i++){
    const hx=(Math.random()-.5)*MAP*.9, hz=(Math.random()-.5)*MAP*.9;
    const hr=8+Math.random()*20, hh=1.5+Math.random()*5;
    const hill=new THREE.Mesh(new THREE.SphereGeometry(hr,8,5,0,Math.PI*2,0,Math.PI/2),
      new THREE.MeshLambertMaterial({color:hc[i%5]}));
    hill.position.set(hx,GY-.5,hz); hill.scale.y=hh/hr;
    hill.castShadow=true; hill.receiveShadow=true; scene.add(hill);
  }

  // Buildings
  const bc=[0xff7755,0x5588ff,0xffcc33,0x55dd88,0xff88cc,0xf0f0f0,0x44ccff,0xff5544,0x88ffaa,0xffaa44];
  const nb=24+Math.floor(Math.random()*10);
  for(let b=0;b<nb;b++){
    const bx=(Math.random()-.5)*MAP*.82, bz=(Math.random()-.5)*MAP*.82;
    const bw=7+Math.random()*18, bd=7+Math.random()*18, bh=5+Math.random()*24;
    const col=bc[Math.floor(Math.random()*bc.length)];
    const m=new THREE.Mesh(new THREE.BoxGeometry(bw,bh,bd),new THREE.MeshLambertMaterial({color:col}));
    m.position.set(bx,GY+bh/2,bz); m.castShadow=true; m.receiveShadow=true; scene.add(m);
    const roof=new THREE.Mesh(new THREE.BoxGeometry(bw+.3,.5,bd+.3),new THREE.MeshLambertMaterial({color:darken(col,.6)}));
    roof.position.set(bx,GY+bh+.25,bz); scene.add(roof);
    for(let w=0;w<5;w++){
      const wm=new THREE.Mesh(new THREE.BoxGeometry(1.3,1.3,.1),
        new THREE.MeshLambertMaterial({color:0xaaddff,transparent:true,opacity:.7}));
      wm.position.set(bx+(Math.random()-.5)*bw*.7,GY+bh*.25+Math.random()*bh*.55,bz+bd/2+.06);
      scene.add(wm);
    }
    bldgs.push({x:bx,z:bz,w:bw,d:bd,h:bh});
  }

  // Trees
  const gc2=[0x228b22,0x2e8b57,0x32cd32,0x006400,0x3cb371];
  for(let t=0;t<65;t++){
    const tx=(Math.random()-.5)*MAP*.9, tz=(Math.random()-.5)*MAP*.9, th=5+Math.random()*10;
    const tc=gc2[Math.floor(Math.random()*5)];
    const trk=new THREE.Mesh(new THREE.CylinderGeometry(.28,.48,th*.45,6),
      new THREE.MeshLambertMaterial({color:0x7a4a1e}));
    trk.position.set(tx,GY+th*.225,tz); trk.castShadow=true; scene.add(trk);
    for(let l=0;l<3;l++){
      const fc=new THREE.Mesh(new THREE.ConeGeometry((2.4-l*.5)+.3,th*.3,8),
        new THREE.MeshLambertMaterial({color:tc}));
      fc.position.set(tx,GY+th*.4+l*th*.22,tz); fc.castShadow=true; scene.add(fc);
    }
  }

  // Rocks
  for(let r=0;r<35;r++){
    const rx=(Math.random()-.5)*MAP*.9, rz=(Math.random()-.5)*MAP*.9, rs=.6+Math.random()*2.2;
    const rock=new THREE.Mesh(new THREE.DodecahedronGeometry(rs,0),
      new THREE.MeshLambertMaterial({color:0x888877}));
    rock.position.set(rx,GY+rs*.45,rz);
    rock.rotation.set(Math.random()*6,Math.random()*6,Math.random()*6);
    rock.castShadow=true; rock.receiveShadow=true; scene.add(rock);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnLoot(){
  for(let i=0;i<50;i++){
    const x=(Math.random()-.5)*MAP*.88, z=(Math.random()-.5)*MAP*.88;
    const r=Math.random();
    const w=r<.24?WEAPONS[0]:r<.43?WEAPONS[2]:r<.59?WEAPONS[1]:r<.72?WEAPONS[3]:r<.84?WEAPONS[4]:r<.93?WEAPONS[5]:WEAPONS[6];
    mkLootW(x,z,w);
  }
  for(let i=0;i<30;i++) mkLootH((Math.random()-.5)*MAP*.88,(Math.random()-.5)*MAP*.88);
  for(let i=0;i<20;i++) mkLootS((Math.random()-.5)*MAP*.88,(Math.random()-.5)*MAP*.88);
}
function mkLootW(x,z,w){
  const g=new THREE.Group();
  g.add(Object.assign(new THREE.Mesh(new THREE.SphereGeometry(.7,8,8),
    new THREE.MeshLambertMaterial({color:w.col3,transparent:true,opacity:.3})),{}));
  const bx=new THREE.Mesh(new THREE.BoxGeometry(.9,.3,.2),new THREE.MeshLambertMaterial({color:w.col3}));
  g.add(bx);
  g.position.set(x,GY+.6,z); scene.add(g);
  loots.push({type:'weapon',w:{...w},mesh:g,x,z,by:GY+.6,picked:false});
}
function mkLootH(x,z){
  const g=new THREE.Group();
  const b=new THREE.Mesh(new THREE.BoxGeometry(.6,.6,.6),new THREE.MeshLambertMaterial({color:0xff3333})); g.add(b);
  const cx=new THREE.Mesh(new THREE.BoxGeometry(.5,.12,.12),new THREE.MeshLambertMaterial({color:0xfff})); cx.position.y=.31; g.add(cx);
  const cy=new THREE.Mesh(new THREE.BoxGeometry(.12,.5,.12),new THREE.MeshLambertMaterial({color:0xfff})); cy.position.y=.31; g.add(cy);
  g.position.set(x,GY+.5,z); scene.add(g);
  loots.push({type:'health',mesh:g,x,z,by:GY+.5,picked:false});
}
function mkLootS(x,z){
  const g=new THREE.Group();
  const s=new THREE.Mesh(new THREE.SphereGeometry(.45,8,8),new THREE.MeshLambertMaterial({color:0x2266ff})); g.add(s);
  g.position.set(x,GY+.5,z); scene.add(g);
  loots.push({type:'shield',mesh:g,x,z,by:GY+.5,picked:false});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let busMesh;
function makeBus(){
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(7,3,3),new THREE.MeshLambertMaterial({color:0x3366ff})); g.add(body);
  const cab=new THREE.Mesh(new THREE.BoxGeometry(6,1.8,2.8),new THREE.MeshLambertMaterial({color:0x5588ff})); cab.position.y=2.2; g.add(cab);
  const ball=new THREE.Mesh(new THREE.SphereGeometry(3.2,12,8),new THREE.MeshLambertMaterial({color:0xffd700})); ball.position.y=5.6; g.add(ball);
  const rope=new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,2.5,4),new THREE.MeshLambertMaterial({color:0x888888})); rope.position.y=3.5; g.add(rope);
  const prop=new THREE.Mesh(new THREE.BoxGeometry(5,.18,.28),new THREE.MeshLambertMaterial({color:0xff6b35})); prop.position.y=5.6; g.add(prop);
  [-2.1,-.7,.7,2.1].forEach(ox=>{
    const wm=new THREE.Mesh(new THREE.BoxGeometry(.7,.7,.1),new THREE.MeshLambertMaterial({color:0xaaddff,transparent:true,opacity:.75}));
    wm.position.set(ox,.5,1.56); g.add(wm);
  });
  g.position.set(BP.x0,BUS_Y,BP.z0); scene.add(g); busMesh=g;
}
function updateBus(dt){
  if(busT>1.4) return;
  busT+=BUS_SPD*(dt*1000);
  const t=Math.min(busT,1);
  busMesh.position.set(BP.x0+(BP.x1-BP.x0)*t, BUS_Y+Math.sin(busT*12)*.4, BP.z0+(BP.z1-BP.z0)*t);
  busMesh.children[4].rotation.y+=dt*5;
  if(busT>=1.0 && phase==='bus') jumpFromBus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER + INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPlayer(){
  player={x:BP.x0, y:BUS_Y, z:BP.z0, hp:100, shield:0, alive:true};
  inv[0]={type:'weapon',w:{...WEAPONS[1]},ammo:WEAPONS[1].ammo};
  aSlot=0; renderInv();
}

function selectSlot(i){
  aSlot=i; renderInv();
  toggleScope(false); // exit scope on slot change
  const it=inv[aSlot];
  if(it&&it.type==='weapon') kfMsg('ğŸ”„ '+it.w.name+' ['+it.w.rar.toUpperCase()+']');
  updateWeaponHUD();
}

function renderInv(){
  for(let i=0;i<5;i++){
    const el=document.getElementById('S'+i);
    const it=inv[i];
    const act=i===aSlot;
    el.className='sl'+(act?' act':'')+(it?' has':'');
    if(!it){
      el.innerHTML=`<span class="sln">${i+1}</span><span class="sli" style="color:#222">â€”</span>`;
    } else if(it.type==='weapon'){
      const wi2=WI[WEAPONS.indexOf(WEAPONS.find(w=>w.name===it.w.name))];
      const ico=wi2?wi2.icon:'ğŸ”«';
      el.innerHTML=`<span class="sln">${i+1}</span><span class="sli">${ico}</span><span class="sll ${RCSS(it.w.rar)}">${it.w.name}</span><span class="sla">${it.ammo}/${it.w.maxAmmo}</span><div class="slr ${RBSS(it.w.rar)}"></div>`;
    } else if(it.type==='health'){
      el.innerHTML=`<span class="sln">${i+1}</span><span class="sli">â¤ï¸</span><span class="sll" style="color:#ff6666">HEALTH</span><span class="sla">+35</span>`;
    } else {
      el.innerHTML=`<span class="sln">${i+1}</span><span class="sli">ğŸ›¡ï¸</span><span class="sll" style="color:#4488ff">SHIELD</span><span class="sla">+50</span>`;
    }
  }
  updateWeaponHUD();
}
function RCSS(r){return{common:'rc',uncommon:'ru',rare:'rr',epic:'re',legendary:'rl'}[r]||'rc';}
function RBSS(r){return{common:'bc',uncommon:'bu',rare:'br',epic:'be',legendary:'bl'}[r]||'bc';}

function addToInv(item){
  if(!inv[aSlot]){inv[aSlot]=item;}
  else{
    for(let i=0;i<5;i++) if(!inv[i]){inv[i]=item;renderInv();return;}
    dropSlot(aSlot); inv[aSlot]=item;
  }
  renderInv();
}

function dropSlot(i){
  const it=inv[i]; if(!it) return;
  inv[i]=null;
  if(player&&player.alive){
    const a=Math.random()*Math.PI*2, d=2.5;
    if(it.type==='weapon') mkLootW(player.x+Math.cos(a)*d, player.z+Math.sin(a)*d, it.w);
    else if(it.type==='health') mkLootH(player.x+Math.cos(a)*d, player.z+Math.sin(a)*d);
    else mkLootS(player.x+Math.cos(a)*d, player.z+Math.sin(a)*d);
  }
  renderInv(); kfMsg('DROPPED ITEM');
}

function useConsumable(){
  const it=inv[aSlot]; if(!it) return;
  if(it.type==='health'){player.hp=Math.min(100,player.hp+35); inv[aSlot]=null; renderInv(); updateHpHUD(); kfMsg('+35 HEALTH');}
  if(it.type==='shield'){player.shield=Math.min(100,player.shield+50); inv[aSlot]=null; renderInv(); updateHpHUD(); kfMsg('+50 SHIELD');}
}

function updateWeaponHUD(){
  const it=inv[aSlot];
  if(!it||it.type!=='weapon'){
    document.getElementById('WN').textContent='â€”';
    document.getElementById('WR').textContent='';
    document.getElementById('WA').textContent='';
    return;
  }
  const w=it.w;
  const css={common:'rc',uncommon:'ru',rare:'rr',epic:'re',legendary:'rl'}[w.rar]||'rc';
  document.getElementById('WN').textContent=w.name;
  document.getElementById('WN').className=css;
  document.getElementById('WR').textContent=w.rar.toUpperCase();
  document.getElementById('WA').textContent=it.ammo;
}

function jumpFromBus(){
  if(phase!=='bus') return;
  phase='freefall'; paraVY=0;
  document.getElementById('PH').textContent='FREEFALLING\nSPACE = deploy chute';
}
function deployChute(){
  if(phase!=='freefall') return;
  phase='chute';
  document.getElementById('PH').textContent='PARACHUTING â€” steer WASD';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAI(){
  const ds=DCFG[diff];
  const aic=[0xff6655,0x55aaff,0xffcc22,0x55ee88,0xff88ff,0xff8844,0x44ccff,0xffaa44,
             0x88ff44,0xff4488,0xffdd44,0x44ffdd,0xee3399,0x33aaee,0xaaee33,
             0xff6600,0x00ff66,0x9966ff,0xff0088,0x0088ff];
  for(let i=0;i<TOTAL-1;i++){
    const ang=(i/(TOTAL-1))*Math.PI*2, dist=15+Math.random()*30;
    const ax=BP.x0+Math.cos(ang)*dist+i*4, az=BP.z0+Math.sin(ang)*dist;
    const wi=Math.floor(Math.random()*WEAPONS.length);
    const w={...WEAPONS[wi]};
    const col=aic[i%aic.length];
    const grp=new THREE.Group();
    // Body cylinder
    const bdy=new THREE.Mesh(new THREE.CylinderGeometry(.42,.48,1.75,8),
      new THREE.MeshLambertMaterial({color:col}));
    bdy.position.y=.875; grp.add(bdy);
    // Head
    const hd=new THREE.Mesh(new THREE.SphereGeometry(.38,8,8),
      new THREE.MeshLambertMaterial({color:col}));
    hd.position.y=2.15; grp.add(hd);
    // Gun
    const gn=new THREE.Mesh(new THREE.BoxGeometry(.12,.12,.8),
      new THREE.MeshLambertMaterial({color:w.col3}));
    gn.position.set(.5,1.6,.65); grp.add(gn);
    grp.position.set(ax,BUS_Y,az);
    scene.add(grp);

    // Floating health bar (3D sprite above head)
    const hpBarGrp=new THREE.Group();
    // Background bar (dark)
    const hpBg=new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.12),new THREE.MeshBasicMaterial({color:0x222222,side:THREE.DoubleSide,depthTest:false}));
    hpBarGrp.add(hpBg);
    // Foreground bar (green -> red)
    const hpFg=new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.10),new THREE.MeshBasicMaterial({color:0x00ff44,side:THREE.DoubleSide,depthTest:false}));
    hpFg.position.z=0.001;
    hpBarGrp.add(hpFg);
    hpBarGrp.position.set(ax,BUS_Y+2.8,az);
    hpBarGrp.renderOrder=999;
    scene.add(hpBarGrp);

    ais.push({
      x:ax, y:BUS_Y, z:az, vy:0,
      hp:ds.hp, maxHp:ds.hp,
      w:{...w}, ammo:w.ammo,
      alive:true, mesh:grp,
      phase:'bus',
      paraT:Math.random()>.35?'chute':'freefall',
      jumpDelay:.04+i*.016+Math.random()*.04,
      state:'roam', target:null,
      reTimer:ds.react+Math.random()*600,
      shootTimer:0,
      roamPt:{x:(Math.random()-.5)*MAP*.75, z:(Math.random()-.5)*MAP*.75},
      id:i,
      hpBar:hpBarGrp, hpFg:hpFg,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doShoot(){
  if(!player||!player.alive||phase!=='ground') return;
  const it=inv[aSlot];
  if(!it||it.type!=='weapon'){kfMsg('NO WEAPON â€” press 1-5');return;}
  const now=Date.now();
  if(now-lastShot<it.w.rate) return;
  if(it.ammo<=0){kfMsg('EMPTY â€” press R');return;}
  lastShot=now; it.ammo--;
  renderInv(); updateWeaponHUD();

  // Shotgun fires multiple pellets
  const pellets=it.w.name==='Shotgun'?6:1;
  for(let p=0;p<pellets;p++){
    fireBullet(player.x,player.y+1.5,player.z, yaw, pitch, it.w, 'player');
  }
}

function doReload(){
  const it=inv[aSlot];
  if(!it||it.type!=='weapon') return;
  it.ammo=it.w.maxAmmo;
  renderInv(); updateWeaponHUD();
  kfMsg('RELOADED â€” '+it.w.name);
}

function fireBullet(ox,oy,oz, ya,pi, w, owner){
  const sp=w.spread;
  let dx=-Math.sin(ya)*Math.cos(pi)+(Math.random()-.5)*sp*2;
  let dy= Math.sin(pi)             +(Math.random()-.5)*sp*2;
  let dz=-Math.cos(ya)*Math.cos(pi)+(Math.random()-.5)*sp*2;
  const len=Math.sqrt(dx*dx+dy*dy+dz*dz)||1;
  dx/=len; dy/=len; dz/=len;
  const spd=w.bspd;

  // Bullet visual â€” longer tracer line
  const geo=new THREE.CylinderGeometry(.04,.04,.6,4);
  geo.rotateX(Math.PI/2);
  const mesh=new THREE.Mesh(geo, new THREE.MeshBasicMaterial({color:w.col3}));
  mesh.position.set(ox,oy,oz);
  // Orient along direction
  mesh.lookAt(ox+dx, oy+dy, oz+dz);
  scene.add(mesh);

  // Muzzle flash
  const fl=new THREE.Mesh(new THREE.SphereGeometry(.3,5,5),new THREE.MeshBasicMaterial({color:0xffff88}));
  fl.position.set(ox,oy,oz); scene.add(fl);
  setTimeout(()=>scene.remove(fl),45);

  bullets.push({mesh, px:ox,py:oy,pz:oz, vx:dx*spd,vy:dy*spd,vz:dz*spd,
    owner, w, dist:0, maxD:w.range, spd});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let nearLoot=null;
function doPickup(){
  if(!nearLoot||nearLoot.picked||phase!=='ground') return;
  nearLoot.picked=true; scene.remove(nearLoot.mesh);
  if(nearLoot.type==='weapon'){
    addToInv({type:'weapon',w:{...nearLoot.w},ammo:nearLoot.w.ammo});
    kfMsg('PICKED UP '+nearLoot.w.name.toUpperCase()+' ['+nearLoot.w.rar.toUpperCase()+']');
  } else if(nearLoot.type==='health'){
    if(player.hp<100){player.hp=Math.min(100,player.hp+35); updateHpHUD(); kfMsg('+35 HEALTH');}
    else{addToInv({type:'health'}); kfMsg('STORED HEALTH PACK');}
  } else {
    if(player.shield<100){player.shield=Math.min(100,player.shield+50); updateHpHUD(); kfMsg('+50 SHIELD');}
    else{addToInv({type:'shield'}); kfMsg('STORED SHIELD ORB');}
  }
  nearLoot=null;
  document.getElementById('PCK').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(){
  requestAnimationFrame(loop);
  if(!gameRunning) return;
  const dt=Math.min(clock.getDelta(),.05);
  gTime+=dt;
  updateBus(dt);
  tickPlayer(dt);
  tickAI(dt);
  tickBullets(dt);
  tickStorm(dt);
  tickLootAnim(dt);
  updateMinimap();
  renderer.render(scene,cam);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER TICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickPlayer(dt){
  if(!player||!player.alive) return;

  if(phase==='bus'){
    const t=Math.min(busT,1);
    player.x=BP.x0+(BP.x1-BP.x0)*t;
    player.z=BP.z0+(BP.z1-BP.z0)*t;
    player.y=BUS_Y;
  } else if(phase==='freefall'){
    paraVY-=28*dt; player.y+=paraVY*dt;
    steerXZ(dt,12);
    if(player.y<=GY+EYE_H){player.y=GY+EYE_H; phase='ground'; onGround=true; hidePH();}
  } else if(phase==='chute'){
    paraVY=Math.max(paraVY,-3); paraVY-=1.2*dt; player.y+=paraVY*dt;
    steerXZ(dt,9);
    if(player.y<=GY+EYE_H){player.y=GY+EYE_H; phase='ground'; onGround=true; hidePH();}
  } else {
    // â”€â”€ GROUND MOVEMENT â”€â”€
    const spd=(keys['ShiftLeft']||keys['ShiftRight'])?9:5.5;
    const fx=-Math.sin(yaw), fz=-Math.cos(yaw);
    const rx=Math.cos(yaw), rz=-Math.sin(yaw);
    if(keys['KeyW']){player.x+=fx*spd*dt; player.z+=fz*spd*dt;}
    if(keys['KeyS']){player.x-=fx*spd*dt; player.z-=fz*spd*dt;}
    if(keys['KeyA']){player.x-=rx*spd*dt; player.z-=rz*spd*dt;}
    if(keys['KeyD']){player.x+=rx*spd*dt; player.z+=rz*spd*dt;}
    player.x=Math.max(-HALF*.97,Math.min(HALF*.97,player.x));
    player.z=Math.max(-HALF*.97,Math.min(HALF*.97,player.z));

    // â”€â”€ JUMP / GRAVITY â”€â”€
    if(!onGround || velY>0){
      velY-=GRAVITY*dt;
      player.y+=velY*dt;
    }
    if(player.y<=GY+EYE_H){
      player.y=GY+EYE_H;
      if(velY<0){ velY=0; onGround=true; }
    } else {
      onGround=false;
    }

    // Jump hint
    document.getElementById('JI').style.display=onGround?'block':'none';
  }

  cam.position.set(player.x, player.y, player.z);
  cam.rotation.y=yaw; cam.rotation.x=pitch;

  // Loot proximity
  nearLoot=null;
  for(const l of loots){
    if(l.picked) continue;
    const dx=l.x-player.x, dz=l.z-player.z;
    if(dx*dx+dz*dz<9){
      nearLoot=l;
      const lbl=l.type==='weapon'?`[E] ${l.w.name.toUpperCase()} (${l.w.rar.toUpperCase()})`:
               l.type==='health'?'[E] HEALTH PACK':'[E] SHIELD ORB';
      document.getElementById('PCK').textContent=lbl;
      document.getElementById('PCK').style.display='block';
      break;
    }
  }
  if(!nearLoot) document.getElementById('PCK').style.display='none';
}

function steerXZ(dt,spd){
  const fx=-Math.sin(yaw), fz=-Math.cos(yaw), rx=Math.cos(yaw), rz=-Math.sin(yaw);
  if(keys['KeyW']){player.x+=fx*spd*dt; player.z+=fz*spd*dt;}
  if(keys['KeyS']){player.x-=fx*spd*dt; player.z-=fz*spd*dt;}
  if(keys['KeyA']){player.x-=rx*spd*dt; player.z-=rz*spd*dt;}
  if(keys['KeyD']){player.x+=rx*spd*dt; player.z+=rz*spd*dt;}
}

function hidePH(){
  document.getElementById('PH').style.display='none';
  document.getElementById('JI').style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI TICK â€” improved: real pathfinding hint, better shooting
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickAI(dt){
  const ds=DCFG[diff];
  for(const ai of ais){
    if(!ai.alive) continue;

    // â”€â”€ PARACHUTE â”€â”€
    if(ai.phase==='bus'){
      const t=Math.min(busT,1);
      ai.x=BP.x0+(BP.x1-BP.x0)*t+(ai.id%5-2)*6;
      ai.z=BP.z0+(BP.z1-BP.z0)*t+(Math.floor(ai.id/5)-2)*5;
      ai.y=BUS_Y;
      if(busT>=ai.jumpDelay) ai.phase=ai.paraT;
      ai.mesh.position.set(ai.x,ai.y,ai.z);
      if(ai.hpBar) ai.hpBar.position.set(ai.x,ai.y+1.5,ai.z);
      continue;
    }
    if(ai.phase==='freefall'||ai.phase==='chute'){
      ai.vy-=(ai.phase==='freefall'?24:1.2)*dt;
      if(ai.phase==='chute') ai.vy=Math.max(ai.vy,-3);
      ai.y+=ai.vy*dt;
      if(ai.y<=GY+EYE_H){ai.y=GY+EYE_H; ai.phase='ground';}
      ai.mesh.position.set(ai.x,ai.y,ai.z);
      if(ai.hpBar) ai.hpBar.position.set(ai.x,ai.y+1.5,ai.z);
      continue;
    }

    // â”€â”€ GROUND â”€â”€
    ai.y=GY+EYE_H;

    // Brain: recalculate target periodically
    ai.reTimer-=dt*1000;
    if(ai.reTimer<=0){
      ai.reTimer=ds.react+Math.random()*800;
      let bd=Infinity, bt=null;
      if(player&&player.alive&&phase==='ground'){
        const dx=player.x-ai.x, dz=player.z-ai.z;
        const d=dx*dx+dz*dz;
        if(d<bd){bd=d; bt='player';}
      }
      for(const o of ais){
        if(o===ai||!o.alive) continue;
        const dx=o.x-ai.x, dz=o.z-ai.z;
        const d=dx*dx+dz*dz;
        if(d<bd){bd=d; bt=o;}
      }
      ai.target=bt;
      ai.state=bd<240*240?'chase':'roam';
      if(Math.random()<.08) ai.roamPt={x:(Math.random()-.5)*MAP*.75,z:(Math.random()-.5)*MAP*.75};
    }

    // Movement
    let tx,tz;
    if(ai.state==='chase'&&ai.target){
      if(ai.target==='player'&&player.alive){tx=player.x; tz=player.z;}
      else if(ai.target.alive){tx=ai.target.x; tz=ai.target.z;}
      else{tx=ai.roamPt.x; tz=ai.roamPt.z;}
    } else {tx=ai.roamPt.x; tz=ai.roamPt.z;}

    const ddx=tx-ai.x, ddz=tz-ai.z, dd2=ddx*ddx+ddz*ddz;
    if(dd2>4){
      const dd=Math.sqrt(dd2);
      const spd=ai.state==='chase'?ds.spd:2.4;
      // Strafing when close to player (makes AI harder to hit)
      let sx=ddx/dd, sz=ddz/dd;
      if(ai.state==='chase' && dd2<80*80){
        const t=gTime*1.5+ai.id;
        const strafe=Math.sin(t)*0.5;
        sx+=(-sz)*strafe; sz+=(sx)*strafe;
        const sl=Math.sqrt(sx*sx+sz*sz)||1;
        sx/=sl; sz/=sl;
      }
      ai.x+=sx*spd*dt; ai.z+=sz*spd*dt;
    }
    ai.x=Math.max(-HALF*.95,Math.min(HALF*.95,ai.x));
    ai.z=Math.max(-HALF*.95,Math.min(HALF*.95,ai.z));

    ai.mesh.position.set(ai.x,ai.y,ai.z);
    if(dd2>4) ai.mesh.lookAt(new THREE.Vector3(tx,ai.y,tz));
    // Billboard health bar to always face camera
    if(ai.hpBar){
      ai.hpBar.position.set(ai.x,ai.y+1.5,ai.z);
      ai.hpBar.quaternion.copy(cam.quaternion);
    }

    // â”€â”€ AI SHOOT â€” aim at target with configurable error â”€â”€
    const tgtEnt=ai.target==='player'
      ?(player&&player.alive&&phase==='ground'?player:null)
      :(ai.target&&ai.target.alive?ai.target:null);

    if(tgtEnt){
      const tdx=tgtEnt.x-ai.x, tdy=(tgtEnt.y||GY+EYE_H)-ai.y, tdz=tgtEnt.z-ai.z;
      const td=Math.sqrt(tdx*tdx+tdz*tdz);
      if(td<ai.w.range){
        ai.shootTimer-=dt*1000;
        if(ai.shootTimer<=0){
          ai.shootTimer=ai.w.rate+(1-ds.acc)*600;
          if(ai.ammo<=0) ai.ammo=ai.w.ammo;
          if(Math.random()<ds.acc){
            ai.ammo--;
            // Calculate accurate aim yaw toward target
            const aimYaw=Math.atan2(-tdx,-tdz);
            const aimPitch=Math.atan2(tdy, td)*0.5; // lead target slightly
            // Add aim error scaled by difficulty
            const errY=aimYaw+(Math.random()-.5)*ds.aimErr;
            const errP=aimPitch+(Math.random()-.5)*ds.aimErr;
            fireBullet(ai.x, ai.y+.3, ai.z, errY, errP, ai.w, 'ai_'+ai.id);
          }
        }
      }
    }

    // Pickup nearby loot
    for(const l of loots){
      if(l.picked) continue;
      const dx=l.x-ai.x, dz=l.z-ai.z;
      if(dx*dx+dz*dz<6){
        l.picked=true; scene.remove(l.mesh);
        if(l.type==='weapon') ai.w={...l.w};
        else if(l.type==='health') ai.hp=Math.min(ai.maxHp,ai.hp+35);
        else ai.hp=Math.min(ai.maxHp,ai.hp+20);
        break;
      }
    }

    // Storm nudge
    const sdx=ai.x-stormCX, sdz=ai.z-stormCZ;
    if(sdx*sdx+sdz*sdz>stormR*stormR){
      const sd=Math.sqrt(sdx*sdx+sdz*sdz)+.001;
      ai.x-=sdx/sd*5*dt; ai.z-=sdz/sd*5*dt;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULLETS â€” correct stepped collision
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickBullets(dt){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];

    // Total distance to move THIS frame = speed * dt
    const frameDist=b.spd*dt;
    // Sub-step size 0.5 units â€” guarantees no skipping even at high speed
    const steps=Math.max(1,Math.ceil(frameDist/0.5));
    const sx=b.vx*dt/steps, sy=b.vy*dt/steps, sz=b.vz*dt/steps;
    const stepDist=frameDist/steps;

    let removed=false;
    for(let s=0;s<steps;s++){
      b.px+=sx; b.py+=sy; b.pz+=sz;
      b.dist+=stepDist;
      b.mesh.position.set(b.px,b.py,b.pz);

      if(b.dist>b.maxD||b.py<GY-0.5){
        spawnBulletImpact(b.px,b.py,b.pz,false);
        scene.remove(b.mesh); bullets.splice(i,1); removed=true; break;
      }

      // HIT PLAYER â€” cylinder check (XZ radius + Y range)
      if(b.owner!=='player'&&player&&player.alive&&phase==='ground'){
        const pdx=player.x-b.px, pdz=player.z-b.pz;
        const pXZsq=pdx*pdx+pdz*pdz;
        const pdy=b.py-(player.y-EYE_H);
        if(pXZsq<1.0*1.0&&pdy>-0.3&&pdy<EYE_H+0.5){
          spawnBulletImpact(b.px,b.py,b.pz,true);
          scene.remove(b.mesh); bullets.splice(i,1);
          hitPlayer(b.w.dmg,b.owner); removed=true; break;
        }
      }

      // HIT AI â€” cylinder check (XZ radius 0.7, Y 0..2.4 above ground)
      let hitAny=false;
      for(const ai of ais){
        if(!ai.alive||b.owner==='ai_'+ai.id) continue;
        const adx=ai.x-b.px, adz=ai.z-b.pz;
        const aXZsq=adx*adx+adz*adz;
        const ady=b.py-GY;
        if(aXZsq<0.7*0.7&&ady>-0.1&&ady<2.4){
          spawnBulletImpact(b.px,b.py,b.pz,true);
          scene.remove(b.mesh); bullets.splice(i,1);
          ai.hp-=b.w.dmg;
          updateAIHealthBar(ai);
          if(ai.hp<=0) killAI(ai,b.owner);
          removed=true; hitAny=true; break;
        }
      }
      if(removed||hitAny) break;
    }
  }
}

function killAI(ai,killer){
  if(!ai.alive) return;
  ai.alive=false;
  scene.remove(ai.mesh);
  if(ai.hpBar){scene.remove(ai.hpBar); ai.hpBar=null;}
  if(killer==='player'){
    kills++; document.getElementById('KN').textContent=kills;
    kfMsg('â˜  ELIMINATED SOLDIER #'+(ai.id+1));
  } else {
    kfMsg('SOLDIER #'+(ai.id+1)+' ELIMINATED');
  }
  updateAlive();
}

// Bullet impact particle
function spawnBulletImpact(x,y,z,isHit){
  const col=isHit?0xff4400:0xffcc44;
  for(let p=0;p<(isHit?5:2);p++){
    const s=new THREE.Mesh(new THREE.SphereGeometry(.08,3,3),new THREE.MeshBasicMaterial({color:col}));
    s.position.set(x+(Math.random()-.5)*.3,y+(Math.random()-.5)*.3,z+(Math.random()-.5)*.3);
    scene.add(s);
    setTimeout(()=>scene.remove(s), isHit?150:80);
  }
}

function hitPlayer(dmg,src){
  if(!player||!player.alive) return;
  if(player.shield>0){const ab=Math.min(player.shield,dmg);player.shield-=ab;dmg-=ab;}
  player.hp-=dmg;
  const df=document.getElementById('DF');
  df.classList.add('on'); setTimeout(()=>df.classList.remove('on'),160);
  updateHpHUD();
  if(player.hp<=0){
    player.alive=false; gameRunning=false;
    const alv=ais.filter(a=>a.alive).length;
    document.getElementById('LK').textContent=kills;
    document.getElementById('LP').textContent='#'+(alv+2);
    document.getElementById('LB2').textContent='TAKEN DOWN BY '+(src.startsWith('ai_')?'AI SOLDIER':'THE STORM');
    document.getElementById('LOSE').classList.add('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickStorm(dt){
  stormR=Math.max(38,HALF*.97-gTime*2.2);
  stormCX=Math.sin(gTime*.04)*22; stormCZ=Math.cos(gTime*.033)*22;
  document.getElementById('SW').style.display=(stormR<HALF*.7)?'block':'none';
  if(player&&player.alive&&phase==='ground'){
    const dx=player.x-stormCX, dz=player.z-stormCZ;
    if(dx*dx+dz*dz>stormR*stormR){
      stormDmgAcc+=dt;
      if(stormDmgAcc>.45){stormDmgAcc=0; hitPlayer(5,'storm');}
    } else stormDmgAcc=0;
  }
  for(const ai of ais){
    if(!ai.alive) continue;
    const dx=ai.x-stormCX, dz=ai.z-stormCZ;
    if(dx*dx+dz*dz>stormR*stormR){ai.hp-=4*dt; if(ai.hp<=0) killAI(ai,'storm');}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOT ANIM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickLootAnim(dt){
  for(const l of loots){
    if(l.picked) continue;
    l.mesh.position.y=l.by+Math.sin(gTime*2+l.x*.1)*.16;
    l.mesh.rotation.y+=dt*2;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateMinimap(){
  const cvs=document.getElementById('MC');
  const ctx=cvs.getContext('2d');
  const W=145,H=145;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='rgba(0,10,22,.94)'; ctx.fillRect(0,0,W,H);
  if(!player) return;
  const sc=W/(MAP*.55);
  ctx.fillStyle='rgba(70,110,170,.42)';
  for(const b of bldgs){
    ctx.fillRect(W/2+(b.x-player.x)*sc-b.w*sc/2,H/2+(b.z-player.z)*sc-b.d*sc/2,b.w*sc,b.d*sc);
  }
  // Storm circle
  ctx.strokeStyle='rgba(160,0,220,.85)'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(W/2+(stormCX-player.x)*sc,H/2+(stormCZ-player.z)*sc,stormR*sc,0,Math.PI*2);
  ctx.stroke();
  // Loot dots
  for(const l of loots){
    if(l.picked) continue;
    const mx=W/2+(l.x-player.x)*sc,mz=H/2+(l.z-player.z)*sc;
    if(mx<0||mx>W||mz<0||mz>H) continue;
    ctx.fillStyle=l.type==='weapon'?'#ffd700':l.type==='health'?'#ff6666':'#4488ff';
    ctx.beginPath(); ctx.arc(mx,mz,1.8,0,Math.PI*2); ctx.fill();
  }
  // AI dots
  for(const ai of ais){
    if(!ai.alive) continue;
    const mx=W/2+(ai.x-player.x)*sc,mz=H/2+(ai.z-player.z)*sc;
    if(mx<0||mx>W||mz<0||mz>H) continue;
    ctx.fillStyle='#ff4444'; ctx.beginPath(); ctx.arc(mx,mz,3,0,Math.PI*2); ctx.fill();
  }
  // Player
  ctx.fillStyle='#00ff88'; ctx.beginPath(); ctx.arc(W/2,H/2,4,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#00ff88'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.lineTo(W/2-Math.sin(yaw)*13,H/2-Math.cos(yaw)*13); ctx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHpHUD(){
  if(!player) return;
  document.getElementById('HPF').style.width=Math.max(0,player.hp)+'%';
  document.getElementById('SHF').style.width=Math.max(0,player.shield)+'%';
}
function updateAIHealthBar(ai){
  if(!ai.hpBar||!ai.hpFg) return;
  const pct=Math.max(0,ai.hp/ai.maxHp);
  // Scale X: full=1.2, empty=0
  ai.hpFg.scale.x=pct;
  // Shift left so bar shrinks from right
  ai.hpFg.position.x=(pct-1)*0.6;
  // Color: green -> yellow -> red
  const col=pct>0.5
    ? new THREE.Color(1-2*(1-pct),1,0)   // green to yellow
    : new THREE.Color(1,pct*2,0);         // yellow to red
  ai.hpFg.material.color=col;
}

function updateAlive(){
  const n=1+ais.filter(a=>a.alive).length;
  document.getElementById('AN').textContent=n;
  if(n<=1&&player&&player.alive){
    gameRunning=false;
    const el=Math.floor((Date.now()-startTime)/1000);
    document.getElementById('WK').textContent=kills;
    document.getElementById('WT').textContent=Math.floor(el/60)+':'+(el%60<10?'0':'')+el%60;
    document.getElementById('WIN').classList.add('show');
  }
}
function kfMsg(txt){
  const kf=document.getElementById('KF');
  const el=document.createElement('div'); el.className='km'; el.textContent=txt;
  kf.appendChild(el); setTimeout(()=>el.remove(),3100);
}
</script>
</body>
</html>
